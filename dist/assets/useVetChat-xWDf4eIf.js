import{c as A,e as I,g as N}from"./format-DsNdWjgr.js";import{g as T,c as X,d as E}from"./differenceInMonths-DSTze7pK.js";import{t as _,g as b,m as x,a as M}from"./differenceInCalendarDays-qwJqrl5B.js";import{j as F,d as Q,p as C,a as S,f as q,e as w,s as m,g as v,r as p}from"./index-DykhQkCz.js";import{s as K}from"./rewards-DUz26ILh.js";function L(e){return A(e,Date.now())}function O(e,t){return+_(e)-+_(t)}function P(e,t,r){const y=O(e,t)/1e3;return T(r==null?void 0:r.roundingMethod)(y)}function k(e,t,r){const y=N(),n=(r==null?void 0:r.locale)??y.locale??I,h=2520,u=X(e,t);if(isNaN(u))throw new RangeError("Invalid time value");const i=Object.assign({},r,{addSuffix:r==null?void 0:r.addSuffix,comparison:u});let l,s;u>0?(l=_(t),s=_(e)):(l=_(e),s=_(t));const o=P(s,l),c=(b(s)-b(l))/1e3,a=Math.round((o-c)/60);let d;if(a<2)return r!=null&&r.includeSeconds?o<5?n.formatDistance("lessThanXSeconds",5,i):o<10?n.formatDistance("lessThanXSeconds",10,i):o<20?n.formatDistance("lessThanXSeconds",20,i):o<40?n.formatDistance("halfAMinute",0,i):o<60?n.formatDistance("lessThanXMinutes",1,i):n.formatDistance("xMinutes",1,i):a===0?n.formatDistance("lessThanXMinutes",1,i):n.formatDistance("xMinutes",a,i);if(a<45)return n.formatDistance("xMinutes",a,i);if(a<90)return n.formatDistance("aboutXHours",1,i);if(a<x){const f=Math.round(a/60);return n.formatDistance("aboutXHours",f,i)}else{if(a<h)return n.formatDistance("xDays",1,i);if(a<M){const f=Math.round(a/x);return n.formatDistance("xDays",f,i)}else if(a<M*2)return d=Math.round(a/M),n.formatDistance("aboutXMonths",d,i)}if(d=E(s,l),d<12){const f=Math.round(a/M);return n.formatDistance("xMonths",f,i)}else{const f=d%12,g=Math.trunc(d/12);return f<3?n.formatDistance("aboutXYears",g,i):f<9?n.formatDistance("overXYears",g,i):n.formatDistance("almostXYears",g+1,i)}}function H(e,t){return k(e,L(e),t)}const R=C("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function U({className:e,variant:t,...r}){return F.jsx("div",{className:Q(R({variant:t}),e),...r})}function G(){const{user:e}=S(),t=q(),r=w({queryKey:["reward-metrics",e==null?void 0:e.id],enabled:!!e,queryFn:async()=>{if(!e)return null;const{data:s,error:o}=await m.from("user_metrics").select("*").eq("user_id",e.id).maybeSingle();if(o)throw o;return s?{userId:s.user_id,credits:s.credits??0,consecutiveDays:s.consecutive_days??0,lastCheckIn:s.last_checkin??void 0,totalEntries:s.total_entries??0,updatedAt:s.updated_at}:null}}),y=w({queryKey:["reward-transactions",e==null?void 0:e.id],enabled:!!e,queryFn:async()=>{if(!e)return[];const{data:s,error:o}=await m.from("credit_transactions").select("*").eq("user_id",e.id).order("created_at",{ascending:!1}).limit(12);if(o)throw o;return(s??[]).map(c=>({id:c.id,delta:c.delta,reason:c.reason,metadata:c.metadata??void 0,createdAt:c.created_at}))}}),n=()=>{t.invalidateQueries({queryKey:["reward-metrics",e==null?void 0:e.id]}),t.invalidateQueries({queryKey:["reward-transactions",e==null?void 0:e.id]})},h=v({mutationFn:async()=>{if(!e)throw new Error("Not authenticated");const{error:s,data:o}=await m.rpc("reward_daily_checkin");if(s)throw s;return o},onSuccess:()=>n()}),u=v({mutationFn:async s=>{if(!e)throw new Error("Not authenticated");const{error:o}=await m.rpc("reward_for_activity",{activity_name:s,event_metadata:{}});if(o)throw o},onSuccess:()=>n()}),i=v({mutationFn:async({amount:s,reason:o})=>{if(!e)throw new Error("Not authenticated");const{error:c}=await m.rpc("spend_credits",{spend_amount:s,spend_reason:o,event_metadata:{}});if(c)throw c},onSuccess:()=>n()}),l=p.useMemo(()=>r.data?Math.min(1,r.data.consecutiveDays/7):0,[r.data]);return{metrics:r.data,isLoading:r.isLoading,transactions:y.data??[],isClaiming:h.isPending,claimDaily:h.mutateAsync,recordActivity:u.mutateAsync,spendCredits:i.mutateAsync,streakProgress:l}}function J(e){const{user:t}=S(),r=q(),[y,n]=p.useState(""),h=w({queryKey:["vet-chat-threads",t==null?void 0:t.id],enabled:!!t,queryFn:async()=>{if(!t)return[];const{data:c,error:a}=await m.from("vet_chat_threads").select("*").eq("user_id",t.id).order("last_message_at",{ascending:!1}).limit(5);if(a)throw a;return(c??[]).map(d=>({id:d.id,status:d.status,topic:d.topic,creditCost:d.credit_cost,createdAt:d.created_at,lastMessageAt:d.last_message_at,vet:void 0}))}}),u=p.useMemo(()=>{var c;return((c=h.data)==null?void 0:c.find(a=>a.status!=="closed"))??null},[h.data]),i=w({queryKey:["vet-chat-messages",u==null?void 0:u.id],enabled:!!(u!=null&&u.id),queryFn:async()=>{if(!u)return[];const{data:c,error:a}=await m.from("vet_chat_messages").select("*").eq("thread_id",u.id).order("created_at",{ascending:!0});if(a)throw a;return(c??[]).map(d=>({id:d.id,threadId:d.thread_id,senderType:d.sender_type,message:d.message,createdAt:d.created_at}))}}),l=()=>{r.invalidateQueries({queryKey:["vet-chat-threads",t==null?void 0:t.id]}),r.invalidateQueries({queryKey:["vet-chat-messages",u==null?void 0:u.id]})},s=v({mutationFn:async({petId:c,topic:a,initialMessage:d,creditCost:f=25})=>{if(!t)throw new Error("Not authenticated");await K(f,"vet_chat_session",{topic:a});const{data:g,error:D}=await m.from("vet_chat_threads").insert({user_id:t.id,pet_id:c||null,topic:a||null,status:"pending",credit_cost:f}).select().single();if(D)throw D;return await m.from("vet_chat_messages").insert({thread_id:g.id,sender_type:"user",sender_id:t.id,message:d}),g},onSuccess:()=>{n(""),l()}}),o=v({mutationFn:async({message:c})=>{if(!t)throw new Error("Not authenticated");if(!u)throw new Error("No active thread");const{error:a}=await m.from("vet_chat_messages").insert({thread_id:u.id,sender_type:"user",sender_id:t.id,message:c});if(a)throw a},onSuccess:()=>l()});return{threads:h.data??[],activeThread:u,messages:i.data??[],isLoadingThreads:h.isLoading,isLoadingMessages:i.isLoading,startThread:s.mutateAsync,isStarting:s.isPending,sendMessage:o.mutateAsync,isSending:o.isPending,pendingTopic:y,setPendingTopic:n,canStartThread:!!e&&!s.isPending}}export{U as B,J as a,H as f,G as u};
