import{a as $,f as E,e as z,s as b,g as F,u as O,b as K,r as h,j as e,X as Q,d as S,t as i}from"./index-DykhQkCz.js";import{M as B,a as H,P as R,B as g}from"./MobileLayout-D0P8EqVx.js";import{I as c}from"./input-BtP13zn0.js";import{P as Y}from"./PetSelector-DeSwfx4H.js";import{P as W}from"./PhotoUpload-DYIKrCeN.js";import{u as X,d as J}from"./useLogs-xxhwBdP6.js";import{u as V}from"./usePhotoUpload-Bns2eVj-.js";import{T as Z}from"./trash-2-AfDv_LSy.js";import{f as T}from"./format-DsNdWjgr.js";import"./PetAvatar-Bi96YrWD.js";import"./plus-CKAhW2G1.js";import"./differenceInCalendarDays-qwJqrl5B.js";import"./rewards-DUz26ILh.js";function ee(){const{user:s}=$(),f=E(),p=z({queryKey:["meal_presets",s==null?void 0:s.id],queryFn:async()=>{if(!s)return[];const{data:r,error:d}=await b.from("meal_presets").select("*").eq("user_id",s.id).order("created_at",{ascending:!1});if(d)throw d;return(r||[]).map(n=>({id:n.id,name:n.name,defaultFoodName:n.default_food_name,defaultMealType:n.default_meal_type||void 0,defaultAmountGrams:n.default_amount_grams??void 0,defaultCalories:n.default_calories??void 0,defaultProteinPercent:n.default_protein_percent??void 0,defaultFatPercent:n.default_fat_percent??void 0,defaultCarbPercent:n.default_carb_percent??void 0,notes:n.notes??void 0,createdAt:n.created_at}))},enabled:!!s}),m=F({mutationFn:async r=>{if(!s)throw new Error("Not authenticated");const{data:d,error:n}=await b.from("meal_presets").insert({user_id:s.id,name:r.name,default_food_name:r.defaultFoodName,default_meal_type:r.defaultMealType||null,default_amount_grams:r.defaultAmountGrams||null,default_calories:r.defaultCalories||null,default_protein_percent:r.defaultProteinPercent||null,default_fat_percent:r.defaultFatPercent||null,default_carb_percent:r.defaultCarbPercent||null,notes:r.notes||null}).select().single();if(n)throw n;return d},onSuccess:()=>{f.invalidateQueries({queryKey:["meal_presets",s==null?void 0:s.id]})}}),x=F({mutationFn:async r=>{if(!s)throw new Error("Not authenticated");const{error:d}=await b.from("meal_presets").delete().eq("id",r);if(d)throw d},onSuccess:()=>{f.invalidateQueries({queryKey:["meal_presets",s==null?void 0:s.id]})}});return{presets:p.data??[],isLoading:p.isLoading,createPreset:m.mutateAsync,isSavingPreset:m.isPending,deletePreset:x.mutateAsync,isDeletingPreset:x.isPending}}const te=["breakfast","lunch","dinner","snack"],ae=["Kibble","Wet Food","Raw","Freeze Dried","Homemade","Treats"];function he(){const s=O(),{pets:f,selectedPet:p,selectedPetId:m,setSelectedPetId:x}=K(),{createLog:r,isCreating:d}=X(m),{uploadPhoto:n,isUploading:v}=V(),{presets:P,isLoading:y,createPreset:A,isSavingPreset:j,deletePreset:k}=ee(),[N,M]=h.useState(null),[G,I]=h.useState(null),[w,_]=h.useState(""),[a,o]=h.useState({foodName:"",customFood:"",amountGrams:"",mealType:"breakfast",notes:"",date:T(new Date,"yyyy-MM-dd"),time:new Date().toTimeString().slice(0,5),calories:"",proteinPercent:"",fatPercent:"",carbPercent:""}),u=a.customFood||a.foodName,D=async()=>{if(!p||!m){i({title:"No pet selected",variant:"destructive"});return}if(!u||!a.amountGrams){i({title:"Please fill in required fields",variant:"destructive"});return}try{let t;if(N){const C=await n(N,"log-photos","food");C&&(t=C)}const l=new Date(`${a.date}T${a.time}`).toISOString();await r({petId:m,foodName:u,amountGrams:parseInt(a.amountGrams),mealType:a.mealType,notes:a.notes||void 0,photoUrl:t,timestamp:l,calories:a.calories?parseInt(a.calories):void 0,proteinPercent:a.proteinPercent?parseInt(a.proteinPercent):void 0,fatPercent:a.fatPercent?parseInt(a.fatPercent):void 0,carbPercent:a.carbPercent?parseInt(a.carbPercent):void 0}),i({title:"Food log added",description:`${u} - ${a.amountGrams}g`}),s("/dashboard")}catch(t){i({title:"Failed to add log",description:t.message,variant:"destructive"})}},q=t=>{o(l=>({...l,foodName:t.defaultFoodName,customFood:"",amountGrams:t.defaultAmountGrams?String(t.defaultAmountGrams):"",mealType:t.defaultMealType||l.mealType,calories:t.defaultCalories?String(t.defaultCalories):"",proteinPercent:t.defaultProteinPercent?String(t.defaultProteinPercent):"",fatPercent:t.defaultFatPercent?String(t.defaultFatPercent):"",carbPercent:t.defaultCarbPercent?String(t.defaultCarbPercent):"",notes:t.notes||l.notes})),i({title:"Preset applied",description:`${t.name} loaded.`})},L=async()=>{if(!u||!a.amountGrams){i({title:"Add required info",description:"Select or enter a food name and amount before saving a preset.",variant:"destructive"});return}const t=w||u;try{await A({name:t,defaultFoodName:u,defaultMealType:a.mealType,defaultAmountGrams:parseInt(a.amountGrams),defaultCalories:a.calories?parseInt(a.calories):void 0,defaultProteinPercent:a.proteinPercent?parseInt(a.proteinPercent):void 0,defaultFatPercent:a.fatPercent?parseInt(a.fatPercent):void 0,defaultCarbPercent:a.carbPercent?parseInt(a.carbPercent):void 0,notes:a.notes||void 0}),i({title:"Preset saved",description:`${t} is ready for next time.`}),_("")}catch(l){i({title:"Unable to save preset",description:l.message,variant:"destructive"})}},U=async t=>{try{await k(t),i({title:"Preset deleted"})}catch(l){i({title:"Unable to delete preset",description:l.message,variant:"destructive"})}};return e.jsxs(B,{children:[e.jsx(H,{title:"Add Food",leftAction:e.jsx("button",{onClick:()=>s(-1),className:"p-2 -ml-2",children:e.jsx(Q,{className:"w-5 h-5"})})}),e.jsxs(R,{className:"space-y-6",children:[e.jsx(Y,{pets:f,selectedPetId:m,onSelectPet:x,showAddButton:!1}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Date"}),e.jsx(c,{type:"date",placeholder:"2024-05-01",value:a.date,onChange:t=>o({...a,date:t.target.value}),max:T(J(new Date,1),"yyyy-MM-dd")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Time"}),e.jsx(c,{type:"time",placeholder:"08:30",value:a.time,onChange:t=>o({...a,time:t.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Food Type"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ae.map(t=>e.jsx("button",{onClick:()=>o({...a,foodName:t,customFood:""}),className:S("px-4 py-2 rounded-full text-sm font-medium transition-all",a.foodName===t?"bg-primary text-primary-foreground":"bg-card-muted hover:bg-card-subtle"),children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Or enter custom food"}),e.jsx(c,{placeholder:"e.g., Chicken",value:a.customFood,onChange:t=>o({...a,customFood:t.target.value,foodName:""})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Meal presets"}),y&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Loadingâ€¦"})]}),P.length===0&&!y?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Save any meal below to auto-fill portions and macros next time."}):e.jsx("div",{className:"space-y-2",children:P.map(t=>e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.defaultAmountGrams?`${t.defaultAmountGrams}g`:"Tap to autofill",t.defaultMealType?` â€¢ ${t.defaultMealType}`:""]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"secondary",size:"sm",onClick:()=>q(t),children:"Use"}),e.jsx("button",{type:"button",onClick:l=>{l.stopPropagation(),U(t.id)},className:"p-1 rounded-lg text-muted-foreground hover:text-destructive transition-colors","aria-label":"Delete preset",children:e.jsx(Z,{className:"w-4 h-4"})})]})]},t.id))})]}),e.jsxs("div",{className:"rounded-xl bg-card-subtle p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Save current meal as preset"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Skip typing later"})]}),e.jsx(c,{placeholder:"Optional preset name",value:w,onChange:t=>_(t.target.value)}),e.jsx(g,{variant:"outline",onClick:L,disabled:j,children:j?"Savingâ€¦":"Save preset"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Amount (grams)"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-card-muted flex items-center justify-center",children:e.jsx("span",{className:"text-lg",children:"ðŸ½ï¸"})}),e.jsx(c,{type:"number",placeholder:"120",value:a.amountGrams,onChange:t=>o({...a,amountGrams:t.target.value}),className:"flex-1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Nutrition (optional)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(c,{type:"number",placeholder:"320",value:a.calories,onChange:t=>o({...a,calories:t.target.value})}),e.jsx(c,{type:"number",placeholder:"32",value:a.proteinPercent,onChange:t=>o({...a,proteinPercent:t.target.value})}),e.jsx(c,{type:"number",placeholder:"18",value:a.fatPercent,onChange:t=>o({...a,fatPercent:t.target.value})}),e.jsx(c,{type:"number",placeholder:"40",value:a.carbPercent,onChange:t=>o({...a,carbPercent:t.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Meal"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:te.map(t=>e.jsx("button",{onClick:()=>o({...a,mealType:t}),className:S("px-4 py-2 rounded-full text-sm font-medium transition-all capitalize",a.mealType===t?"bg-primary text-primary-foreground":"bg-card-muted hover:bg-card-subtle"),children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Additional Notes"}),e.jsx("textarea",{placeholder:"e.g., Mixed with warm water for easier chewing",value:a.notes,onChange:t=>o({...a,notes:t.target.value}),className:"w-full h-24 rounded-xl bg-card-subtle px-4 py-3 text-foreground placeholder:text-muted-foreground resize-none focus:outline-none focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Photo (optional)"}),e.jsx(W,{value:G,onChange:I,onFileSelect:M,isUploading:v,size:"lg",shape:"square",className:"w-full h-32"})]}),e.jsx(g,{onClick:D,className:"w-full mt-8",disabled:d||v,children:d||v?"Adding...":"Add Food"}),e.jsx(g,{variant:"secondary",onClick:()=>s("/add-supplement"),className:"w-full",children:"Add Supplements"})]})]})}export{he as default};
